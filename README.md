# openshift-keycloak



## Getting started

Add resources to openshift to install the RH-SSO Operator into a specific namespace 'rh-sso' 


```

oc new-project rh-sso
oc apply -f templates/operatorgroup.yaml
oc apply -f templates/operator.yaml

```

The above command will add the necessary resources (Subscription and OperatorGroup) to install the RH-SSO operator into the namespace. 

## Update primary image location 

You can update the location of the primary operator image for the RH-SSO operator. The image is the following:

```
registry.redhat.io/rh-sso-7/sso7-rhel8-operator

```
This may be due to issues such as the following:
- Problems with default Harbor Proxy cache for redhat.registry.io
- Need to specify private registry to group images for Aqua scan exception


To override the default location where Openshift pulls the image 
You can you can edit the ClusterServiceVersion. Note: A ClusterServiceVersion (CSV) represents a particular version of a running operator on a cluster. It includes metadata such as name, description, version, repository link, labels, icon, etc.

```
oc edit csv/rhsso-operator.7.6.1-opr-001
```

And change the "image" field. For example:
(TBD patch command to do this?)

```
apiVersion: operators.coreos.com/v1alpha1
kind: ClusterServiceVersion
metadata:
  annotations:
    containerImage: >-
      lmregistry.us.lmco.com/lmc.eo.mdw.openshift/rh-sso-7/sso7-rhel8-operator:7.6-6

```
This will allow you to specify the location (in harbor) of the primary operator image. 


## Give project-admin users ability to install / update /delete the Keycloak resources

To allow project-admin users the ability to create  / update /delete the Keycloak resources,
the  ClusterRole 'keycloak-project-admin' should be created.  This will then be applied to users 
and that gives a (project admin) user necessary privileges to install Keycloak (and associated resources) via the RH-SSO Operator: 

```

$ oc apply -f templates/cluster-role-keycloak-project-admin.yaml 
$ oc adm policy add-role-to-user keycloak-project-admin <user name> -n rh-sso

```

## Secret with Admin console credentials 

If it doesn't already exist in the namespace, a secret 'credential-${keycloak name}' gets created automatically when you apply the Keycloak CR. However the password for the admin account gets created with random admin password.  

The following is the name of the secret automatically created by the operator on apply of the Keycloak CR:

```
credentials-<CR-Name> - Admin username and password to log into the Red Hat Single Sign-On admin console (the <CR-Name> is based on the Keycloak custom resource name)
```

Further documenation of the resource generated by the keycloak CR is here
- https://access.redhat.com/documentation/en-us/red_hat_single_sign-on/7.6/html-single/server_installation_and_configuration_guide/index#keycloak_cr

You have the option to create the secret with this name before you run the 'oc apply' to apply the keycloak CR, and keycloak will use this named secret to set the admin user/password .

# Create Keycloak instance 

For more information on creating keycloak instance from CR see section in documentation:

https://access.redhat.com/documentation/en-us/red_hat_single_sign-on/7.6/html/server_installation_and_configuration_guide/operator#keycloak_cr


To appply the CR to create rh-sso instance and associated resources.
You can customize the name given to the keycloak deployment by specifying 
a value for the template parameter RH_SSO_NAME (see the yaml file). 
This can be passed to the template using e.g. '-p RH_SSO_NAME=<CR-name>' .
The following will apply with default name <CR-name> set to "keycloak".

``` shell
oc process -f ./templates/keycloak.yaml | oc apply -f -
```

Had you not created the secret containing admin user/pass beforehand the following commands could be used to get password where keycloak instance 'keycloak' user/pass credentials kept 
Note: this only works in Linux environment (not windows).  If on windows, to get the value of user/pass login credentials,
go to the openshift console and lookup values in secret 'credential-keycloak'. 

```

$ oc get keycloak keycloak --output="jsonpath={.status.credentialSecret}"
$ oc get secret <secret name returned above> -o go-template='{{range $k,$v := .data}}{{printf "%s: " $k}}{{if not $v}}{{$v}}{{else}}{{$v | base64decode}}{{end}}{{"\n"}}{{end}}'

```

Check status of pod 

```

$ oc get keycloak 
$ oc describe keycloak keycloak

```

To delete - this deletes all CRs in the yaml, including secrets.

```

$ oc process -f ./templates/keycloak.yaml | oc delete -f -

```
